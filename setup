#!/bin/bash

# shellcheck disable=SC2154
trap 'ret=$?; test $ret -ne 0 && printf "failed\n\n" >&2; exit $ret' EXIT

set -e

# Ask for the administrator password upfront
sudo -v

# Keep-alive: update existing `sudo` time stamp until `setup` has finished
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

if ! command -v brew >/dev/null; then
  echo "Installing Homebrew ..."
    curl -fsS \
      'https://raw.githubusercontent.com/Homebrew/install/master/install' | ruby

    export PATH="/usr/local/bin:$PATH"
fi

if ! command -v mas >/dev/null; then
  brew install mas
fi

echo "Installing XCode..."

# mas signin is currently broken
# https://github.com/mas-cli/mas/issues/164
# if ! mas account >/dev/null; then
#   echo -n "Mac App Store Password:"
#   read -rs password
#   echo
#   mas signin "jacob@jacobsmith.io" "$password"
# fi

sudo xcodebuild -license accept

echo "Updating Homebrew formulae ..."
brew update
brew bundle --file=- <<EOF
tap "homebrew/services"

tap "Goles/battery"
brew "battery"

tap "nodenv/nodenv"
brew "nodenv-default-packages"

tap "thoughtbot/formulae"
brew "rcm"

tap "chrokh/tap"
brew "base16-manager"

brew "awscli"
brew "cmake"
brew "coreutils"
brew "ctags"
brew "dialog"
brew "diff-so-fancy"
brew "dnsmasq"
brew "emojify"
brew "exercism"
brew "findutils"
brew "fzf"
brew "gawk"
brew "gdb"
brew "gist"
brew "git"
brew "git-crypt"
brew "go"
brew "hub"
brew "jq"
brew "kafkacat"
brew "neovim"
brew "netcat"
brew "nodenv"
brew "openssl"
brew "overmind"
brew "python"
brew "rbenv"
brew "rbenv-bundler"
brew "rbenv-ctags"
brew "rbenv-default-gems"
brew "reattach-to-user-namespace"
brew "rmtrash"
brew "ruby-build"
brew "ssh-copy-id"
brew "the_silver_searcher"
brew "tig"
brew "tmate"
brew "tmux"
brew "tree"
brew "vim"
brew "watch"
brew "watchman"
brew "zplug"
brew "zsh"

tap "caskroom/fonts"
cask "font-firacode-nerd-font"

tap "homebrew/cask-drivers"
cask "logitech-options"

cask "1password"
cask "1password-cli"
cask "airtable"
cask "alfred"
cask "amethyst"
cask "appcleaner"
cask "bartender"
cask "base"
cask "choosy"
cask "dash"
cask "docker"
cask "dropbox"
cask "firefox"
cask "google-chrome"
cask "hazel"
cask "iterm2"
cask "kaleidoscope"
cask "karabiner-elements"
cask "keep-it"
cask macvim
cask "marked"
cask "monodraw"
cask "muzzle"
cask "paw"
cask "postico"
cask "quitter"
cask "reflector"
cask "rocket"
cask "sketch"
cask "spotify"
cask "thingsmacsandboxhelper"
cask "tinderbox"
cask "transmit-disk"
cask "tripmode"
cask "vagrant"
cask "visual-studio-code"

mas '1Blocker', id: 1107421413
mas 'Airmail 3', id: 918858936
mas 'Copied', id: 1026349850
mas 'Deckset', id: 847496013
mas 'Fantastical 2', id: 975937182
mas 'Horo', id: 1437226581
mas 'Keynote', id: 409183694
mas 'Magnet', id: 441258766
mas 'MindNode', id: 1289197285
mas 'Numbers', id: 409203825
mas 'OmniOutliner', id: 1142578772
mas 'Pages', id: 409201541
mas 'Pixelmator', id: 407963104
mas 'PopClip', id: 445189367
mas 'ReadKit', id: 588726889
mas 'Sequence Diagram', id: 1195426709
mas 'Shush', id: 496437906
mas 'Slack', id: 803453959
mas 'Spillo', id: 873245660
mas 'Things3', id: 904280696
mas 'Tooth Fairy', id: 1191449274
mas 'Transmit', id: 403388562
mas 'Trello', id: 1278508951
mas 'iA Writer', id: 775737590
EOF

echo "Cleaning up old Homebrew formulae ..."
brew cleanup

echo "Configuring Python for NeoVim ..."
pip3 install neovim

defaults write com.pilotmoon.popclip OtherURLSchemes -array keepit papers3 spotify things

if [ ! -d "$HOME/.dotfiles" ]; then
  git clone https://github.com/iakobos/dotfiles.git "$HOME/.dotfiles"
fi

read -p "1Password subdomain: " opsubdomain
read -p "1Password email: " opemail
eval $(op signin "$opsubdomain.1password.com" "$opemail")

keyfile=$(mktemp)
op get document dotfiles.key > $keyfile

pushd "$HOME/.dotfiles"
git crypt unlock $keyfile
popd

RCRC="$HOME/.dotfiles/rcrc" rcup -f
