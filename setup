#!/bin/bash

set -e

# Ensure shell is zsh
shell_path="/usr/local/bin/zsh"
if ! grep "$shell_path" /etc/shells > /dev/null 2>&1 ; then
  echo "Adding '$shell_path' to /etc/shells"
  sudo sh -c "echo $shell_path >> /etc/shells"
fi

case "$SHELL" in
  */zsh) : ;;
  *)
    echo "Changing your shell to zsh ..."
      chsh -s "$(which zsh)"
    ;;
esac

if [ ! -f "$HOME/.dotfiles/.git/git-crypt/keys/default" ]; then
  read -p "1Password subdomain: " opsubdomain
  read -p "1Password email: " opemail
  eval $(op signin "$opsubdomain.1password.com" "$opemail")

  keyfile=$(mktemp)
  op get document dotfiles.key > $keyfile

  pushd "$HOME/.dotfiles"
  git crypt unlock $keyfile
  popd
fi
