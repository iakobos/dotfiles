#! /bin/bash

set -e

# Set the volume name using `sudo diskutil rename "NO NAME" "SECRETS"`
VOLUME_LABEL="SECRETS"
VOLUME_PATH="$(dirname $0)/../private.vc"
VERACRYPT='/Applications/Veracrypt.app/Contents/MacOS/VeraCrypt'
MOUNT_POINT="$HOME/.dotfiles-private/"

if hash $veracrypt 2>/dev/null; then
  $VERACRYPT -t -k "" --protect-hidden=no $VOLUME_PATH $MOUNT_POINT
  DEVICE_ID=`/usr/libexec/PlistBuddy -c "Print AllDisksAndPartitions:0:DeviceIdentifier" /dev/stdin <<< $(diskutil list -plist $VOLUME_LABEL)`
  diskutil unmount "$DEVICE_ID"
  mkdir -p $MOUNT_POINT
  sudo mount -r -t msdos -o "-u=$UID,-m=700" "/dev/$DEVICE_ID" $MOUNT_POINT
fi
